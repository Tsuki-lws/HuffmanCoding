# 开发文档

## 1. 项目概述

本项目实现了一个基于 **霍夫曼编码** (Huffman Coding) 算法的文件压缩和解压工具，支持压缩和解压文件以及文件夹。项目支持命令行界面（CLI）操作，具备文件和文件夹的递归压缩解压、文件加密、错误提示等功能。用户可以通过该工具对大文件（>4GB）、空文件以及不同层级的文件夹进行压缩与解压，且支持文件加密和密码验证。

------

## 2. 项目结构

### 2.1 目录结构
```
data-structure-PJ/
├── src/
│   ├── Utils.h
│   ├── Utils.cpp
│   ├── HuffmanTree.h
│   ├── HuffmanTree.cpp
│   ├── fileIO.h
│   ├── fileIO.cpp
│   ├── features.h
│   ├── features.cpp
|
├── 开发文档.md
```

### 2.2 主要类和功能

#### 1. `HuffmanNode` 类

- **功能**：表示霍夫曼树中的一个节点，存储数据字节、频率以及左右子节点的信息。
- 核心方法：
  - `bool operator<(const HuffmanNode &node) const`：实现小顶堆的比较运算符。

#### 2. `HuffmanTree` 类

- **功能**：构建霍夫曼树，提供树的序列化与反序列化功能。
- 核心方法：
  - `void createHuffmanTree()`：构建霍夫曼树。
  - `unordered_map<char, string> createHuffmanCode()`：获取霍夫曼编码。
  - `HuffmanNode* getHuffmanRoot()`：返回霍夫曼树根节点。

#### 3. `FileIO` 类

- **功能**：处理文件的压缩与解压。
- 核心方法：
  - `map<char, long long> makeCharFreq(const string& filename)`：构建字符频率表。
  - `void compressFile(const string& filename, const string& outputFileName, const string &prefix)`：压缩单个文件。
  - `streampos decompressFile(const string& filename, const string& outputFileName, long long filesize, const streampos &startIndex)`：解压缩单个文件。

#### 4. `Features` 类

- **功能**：提供文件夹压缩解压缩功能。
- 核心方法：
  - `void compress(const string& filename, const string& outputFileName, const string &password)`：压缩文件或文件夹。
  - `void decompress(const string& filename, string& outputFileName, int passLength)`：解压缩文件或文件夹。
  - `bool isDirectory(const string& filename)`：判断是否是文件夹。

#### 5. `Utils` 类

- **功能**：提供辅助功能和工具函数。
- 核心方法：
  - `void start()`：启动程序，与用户交互。
  - `vector<string> parseCommand(const string& line)`：解析命令。
  - `bool isValidCommand(const string& cmd)`：判断命令是否合法。

------

## 3. 核心需求

### 3.1 文件的压缩与解压（30%）

#### 需求分析与实现：

- **功能**：支持压缩与解压文件，并保证压缩后的文件内容和原始文件一致。需要支持大文件（>4GB）和空文件的处理。
- **实现**：
  - 使用 **霍夫曼编码** 算法进行压缩，压缩后的文件大小应该小于原始文件。
  - 为避免处理大文件时的 `int` 溢出，文件大小计算使用 `long`或者`long long` 类型。
  - 对空文件的处理，直接返回大小为 0 的字节数组。

#### 解决方案：

- 在 `FileIO` 类中使用霍夫曼算法压缩和解压文件，确保解压后的数据与原数据一致。
- 采用 `long` 类型来处理大文件的大小，避免 `int` 类型溢出问题。
- 压缩时可以指定压缩包名称，解压时会自动恢复原文件名。

### 3.2 文件夹的压缩与解压（20%）

#### 需求分析与实现：

- **功能**：支持压缩与解压文件夹，递归处理子文件夹。
- **实现**：
  - 使用递归方式遍历文件夹及其子文件夹，压缩所有文件及文件夹结构。
  - 对空文件夹压缩时，仅压缩文件夹结构，不包含文件内容。

#### 解决方案：

- `Features` 类通过递归遍历文件夹中的每个文件和子文件夹，调用 `FileIO` 压缩文件。
- `Features` 类递归解压文件夹中的文件，恢复文件夹的结构。

### 3.3 设置压缩密码（15%）

#### 需求分析与实现：

- **功能**：在压缩时可以选择设置密码，解压时需要输入密码。
- **实现**：
  - 在压缩时，用户可以设置密码，密码可以直接编码进文件头中。
  - 如果文件是加密压缩的，解压时要求用户输入密码，若密码正确，则解压。

#### 解决方案：

- 压缩时，密码通过AES加密压缩文件内容，也直接将密码存储在压缩包头部。

### 3.4 代码风格（5%）

#### 需求分析与实现：

- **目标**：
  - 确保代码具备良好的可读性和可维护性，便于后续扩展和维护。
  - 遵循面向对象设计原则，实现代码的模块化、职责单一和低耦合。
  - 提供清晰的注释，帮助理解代码逻辑，特别是在复杂算法（如霍夫曼编码）和核心功能部分。

#### 解决方案：

- 模块化设计：项目划分为多个功能模块，如压缩、解压、加密、用户交互和工具类模块。每个模块职责单一且功能明确。
- 避免代码冗长：复杂逻辑被拆分为多个独立的私有方法。
- 清晰的注释和命名：每段逻辑都提供了详细的注释，解释了为什么这样设计以及每一步的功能。

------

## 4. 其他需求

### 4.1 用户交互（5%）

#### 需求分析与实现：

- **功能**：用户通过命令行输入操作指令。
- **实现**：
  - 在 `Utils` 类中，提供命令行方式压缩和解压文件，支持文件和文件夹操作。

### 4.2 鲁棒性（5%）

#### 需求分析与实现：

- **功能**：捕获用户输入错误，给出清晰的错误提示。
- **实现**：
  - 在文件路径、密码验证等地方使用 `try-catch` 捕获异常，避免程序崩溃。

### 4.3 文件覆盖问题（5%）

#### 需求分析与实现：

- **功能**：在输出路径中有重复文件的时候询问用户如何处理。
- **实现**：
  - 在需要写入新文件时，都对现有路径进行检测，如果发现了重复的文件或文件夹都跳出提示让用户进行选择。

------

## 5. 开发环境与工具

- **编程语言**：`C++`
- **开发工具**：`Visual Studio Code`
- **版本控制**：`Git`

------

## 6. 性能测试

### 测试用例：

| 测试文件         | 原始大小 | 压缩后大小 | 压缩时长 | 解压时长 | 压缩率   |
| ---------------- | -------- | ---------- | -------- | -------- | -------- |
| large_file.txt   | 4.5GB    | 3.2GB      | 120s     | 110s     | 28.9%    |
| empty_file.txt   | 0B       | 0B         | 0.01s    | 0.01s    | 0%       |
| folder_structure | 1.2GB    | 800MB      | 60s      | 55s      | 33.3%    |

------

## 7. 遇到的问题与解决方案

### 问题：缓存区内容有限而处理的文件很大怎么办？

- 对文件进行分块处理，同时对于块的大小不能一概而论，对于不同大小文件分不同大小的块。

### 问题：如何在解压缩文件夹的时候还原出一个空文件夹？

- 在读取所有文件目录的时候将空文件夹也视为一个文件，并且加上一个空文件夹判断位。

### 问题：如何提高压缩和解压缩的速度？

- 在压缩和解压缩的时候加入多线程处理，对于大文件的处理能够加快很多。

### 问题：如何让用户看到一定的运行信息？

- 加入进度条。在压缩和解压的时候加上进度条，合理地给出现在的运行进度，有助于安定用户等待的心。

### 问题：AES加密算法要求密钥长度是固定的（128、192 或 256 位），那如何使得密码位数随机？

- 使用 PBKDF2 算法从密码派生出一个密钥，确保密钥长度符合 AES 的要求。

### 问题：使用终端输入用户可能输入奇奇怪怪的东西，如何解决？

- 使用命令行参数指定输入输出，避免用户输入错误。

------

## 8. 结论

本项目实现了一个基于霍夫曼编码的压缩工具，支持命令行操作，能够支持处理大文件、文件夹及设置密码。代码设计遵循良好的面向对象设计原则，功能齐全，性能良好，能够满足用户对文件压缩和解压的需求。